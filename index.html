<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MinuteMate - Meeting Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; transition: background-color 0.3s ease; }
        .status-idle { background-color: #6b7280; }
        .status-recording { background-color: #ef4444; animation: pulse 1.5s infinite; }
        .status-processing { background-color: #f59e0b; animation: pulse 1.5s infinite; }
        .status-complete { background-color: #22c55e; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .transcript-word { cursor: pointer; padding: 1px 2px; border-radius: 3px; transition: background-color 0.2s ease; }
        .transcript-word:hover { background-color: #fde68a; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col items-center min-h-screen p-4 sm:p-8">

    <div class="w-full max-w-4xl bg-white shadow-lg rounded-2xl p-6 sm:p-8">
        
        <!-- Header -->
        <header class="flex justify-between items-center border-b pb-4 mb-6">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">MinuteMate</h1>
                <p class="text-gray-500">Your AI Meeting Assistant</p>
            </div>
            <div id="status-indicator" class="flex items-center space-x-2 bg-gray-100 px-3 py-1.5 rounded-full">
                <span id="status-dot" class="status-dot status-idle"></span>
                <span id="status-text" class="font-semibold text-sm">Idle</span>
            </div>
        </header>

        <!-- Controls -->
        <div class="space-y-6">
            <!-- Live Recording Controls -->
            <div class="text-center">
                <h3 class="text-lg font-medium mb-2">Live Recording</h3>
                <div class="flex items-center justify-center space-x-4">
                    <button id="start-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">Start Recording</button>
                    <button id="stop-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105" disabled>Stop Recording</button>
                </div>
            </div>

            <div class="flex items-center text-center">
                <hr class="flex-grow border-gray-300"><span class="px-4 text-gray-500 font-semibold">OR</span><hr class="flex-grow border-gray-300">
            </div>

            <!-- *** NEW: File Upload Controls *** -->
            <div class="text-center">
                <h3 class="text-lg font-medium mb-2">Upload an Audio File</h3>
                <div class="flex items-center justify-center space-x-4">
                    <input type="file" id="audio-file-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    <button id="upload-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md">Upload & Process</button>
                </div>
                <p id="upload-error" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>
        </div>

        <hr class="my-8 border-gray-200">

        <!-- Results Area -->
        <div id="results-area" class="hidden space-y-8">
            <div><h2 class="text-xl font-bold mb-3 border-l-4 border-blue-500 pl-3">Meeting Summary</h2><div id="summary" class="bg-blue-50 p-4 rounded-lg text-gray-700 leading-relaxed"></div></div>
            <div><h2 class="text-xl font-bold mb-3 border-l-4 border-yellow-500 pl-3">Action Items</h2><ul id="action-items" class="list-disc list-inside space-y-2 bg-yellow-50 p-4 rounded-lg"></ul></div>
            <div><h2 class="text-xl font-bold mb-3 border-l-4 border-green-500 pl-3">Reminders & Dates</h2><ul id="reminders" class="list-disc list-inside space-y-2 bg-green-50 p-4 rounded-lg"></ul></div>
            <div><h2 class="text-xl font-bold mb-3 border-l-4 border-gray-500 pl-3">Full Transcript</h2><div id="transcript" class="bg-gray-100 p-4 rounded-lg h-64 overflow-y-auto text-gray-600 leading-relaxed"></div></div>
            <div class="text-center pt-4"><button id="save-btn" class="hidden bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-5 rounded-lg shadow-md">Save Minutes to File</button></div>
        </div>

        <!-- Initial Message / Loading Area -->
        <div id="initial-message" class="text-center text-gray-500 py-16">
            <p>Record a live meeting or upload an audio file to begin.</p>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const saveBtn = document.getElementById('save-btn');
        const uploadBtn = document.getElementById('upload-btn'); // *** NEW
        const fileInput = document.getElementById('audio-file-input'); // *** NEW
        const uploadError = document.getElementById('upload-error'); // *** NEW
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const resultsArea = document.getElementById('results-area');
        const initialMessage = document.getElementById('initial-message');
        
        const API_URL = 'http://127.0.0.1:5000';

        let currentMeetingId = null;
        let statusInterval = null;
        let previousStatus = "idle";

        function updateUI(status) {
            statusDot.className = 'status-dot';
            switch (status) {
                case 'recording':
                    statusDot.classList.add('status-recording');
                    statusText.textContent = 'Recording';
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    uploadBtn.disabled = true;
                    fileInput.disabled = true;
                    initialMessage.innerHTML = '<p class="text-red-500 font-semibold">Recording in progress...</p>';
                    resultsArea.classList.add('hidden');
                    saveBtn.classList.add('hidden');
                    break;
                case 'processing':
                    statusDot.classList.add('status-processing');
                    statusText.textContent = 'Processing';
                    startBtn.disabled = true;
                    stopBtn.disabled = true;
                    uploadBtn.disabled = true;
                    fileInput.disabled = true;
                    initialMessage.innerHTML = '<p class="text-yellow-500 font-semibold">Processing meeting notes... Please wait.</p>';
                    break;
                case 'idle':
                default:
                    if (statusText.textContent !== 'Complete') {
                        statusDot.classList.add('status-idle');
                        statusText.textContent = 'Idle';
                        initialMessage.innerHTML = '<p>Record a live meeting or upload an audio file to begin.</p>';
                    }
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    uploadBtn.disabled = false;
                    fileInput.disabled = false;
                    break;
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const data = await response.json();
                
                if (previousStatus === 'processing' && data.status === 'idle') {
                    clearInterval(statusInterval);
                    statusInterval = null;
                    fetchResults();
                } else {
                    updateUI(data.status);
                }
                previousStatus = data.status;
            } catch (error) {
                console.error('Error checking status:', error);
                statusText.textContent = 'Disconnected';
                statusDot.className = 'status-dot bg-gray-400';
                clearInterval(statusInterval);
            }
        }

        async function fetchResults() {
            if (!currentMeetingId) return;
            try {
                const response = await fetch(`${API_URL}/minutes/${currentMeetingId}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                document.getElementById('summary').textContent = data.summary;
                const actionItemsList = document.getElementById('action-items');
                actionItemsList.innerHTML = '';
                if (data.action_items.length > 0) {
                    data.action_items.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        actionItemsList.appendChild(li);
                    });
                } else {
                    actionItemsList.innerHTML = '<li>No action items detected.</li>';
                }
                const remindersList = document.getElementById('reminders');
                remindersList.innerHTML = '';
                if (data.reminders.length > 0) {
                    data.reminders.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        remindersList.appendChild(li);
                    });
                } else {
                    remindersList.innerHTML = '<li>No reminders detected.</li>';
                }
                const transcriptContainer = document.getElementById('transcript');
                transcriptContainer.innerHTML = '';
                data.timed_transcript.forEach(segment => {
                    segment.words.forEach(word => {
                        const span = document.createElement('span');
                        span.className = 'transcript-word';
                        span.textContent = word.text + ' ';
                        transcriptContainer.appendChild(span);
                    });
                });

                resultsArea.classList.remove('hidden');
                initialMessage.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                statusDot.className = 'status-dot status-complete';
                statusText.textContent = 'Complete';
                startBtn.disabled = false;
                uploadBtn.disabled = false;
                fileInput.disabled = false;
                currentMeetingId = null;
                previousStatus = 'idle';
            } catch (error) {
                console.error('Error fetching results:', error);
                initialMessage.innerHTML = `<p class="text-red-500">Error fetching results: ${error.message}</p>`;
                initialMessage.classList.remove('hidden');
            }
        }

        function saveResultsToFile() {
            const summary = document.getElementById('summary').textContent;
            const actionItems = Array.from(document.querySelectorAll('#action-items li')).map(li => `- ${li.textContent}`).join('\n');
            const reminders = Array.from(document.querySelectorAll('#reminders li')).map(li => `- ${li.textContent}`).join('\n');
            const transcript = document.getElementById('transcript').textContent;
            const fileContent = `MinuteMate Meeting Notes\n=========================\n\n## Summary\n${summary}\n\n## Action Items\n${actionItems}\n\n## Reminders & Dates\n${reminders}\n\n## Full Transcript\n-----------------\n${transcript}`;
            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const timestamp = new Date().toISOString().slice(0, 10);
            link.setAttribute('download', `meeting-minutes-${timestamp}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        startBtn.addEventListener('click', async () => {
            try {
                resultsArea.classList.add('hidden');
                initialMessage.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                const response = await fetch(`${API_URL}/start_recording`, { method: 'POST' });
                const data = await response.json();
                currentMeetingId = data.meeting_id;
                updateUI('recording');
                previousStatus = 'recording';
                if (!statusInterval) statusInterval = setInterval(checkStatus, 2000);
            } catch (error) {
                console.error('Error starting recording:', error);
            }
        });

        stopBtn.addEventListener('click', async () => {
            try {
                await fetch(`${API_URL}/stop_recording`, { method: 'POST' });
                updateUI('processing');
                previousStatus = 'processing';
            } catch (error) {
                console.error('Error stopping recording:', error);
            }
        });

        saveBtn.addEventListener('click', saveResultsToFile);

        // *** NEW: Event listener for upload button ***
        uploadBtn.addEventListener('click', async () => {
            uploadError.textContent = '';
            const file = fileInput.files[0];
            if (!file) {
                uploadError.textContent = 'Please select a file first.';
                return;
            }

            resultsArea.classList.add('hidden');
            initialMessage.classList.remove('hidden');
            saveBtn.classList.add('hidden');

            const formData = new FormData();
            formData.append('audio_file', file);

            try {
                const response = await fetch(`${API_URL}/upload_audio`, {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Upload failed.');
                }

                currentMeetingId = data.meeting_id;
                updateUI('processing');
                previousStatus = 'processing';
                if (!statusInterval) statusInterval = setInterval(checkStatus, 2000);

            } catch (error) {
                console.error('Error uploading file:', error);
                uploadError.textContent = error.message;
            }
        });

        // Initial Load
        checkStatus();
        if (!statusInterval) statusInterval = setInterval(checkStatus, 2000);
    </script>
</body>
</html>
